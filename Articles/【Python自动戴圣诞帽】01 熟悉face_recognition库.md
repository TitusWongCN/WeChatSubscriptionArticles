> 近两三年每次一到圣诞节，朋友圈里面就各种“@微信官方 给我一顶圣诞帽”。先不说微信官方到底给没给，本着“求人不如求己”的想法，这次我们来用`Python`写一个自动戴圣诞帽的脚本。


### 缘起

每到圣诞节，朋友圈就会变得热闹起来。大家都争先恐后向微信官方讨要圣诞帽：

![](https://user-gold-cdn.xitu.io/2020/1/12/16f98c1884516735?w=749&h=579&f=png&s=149327)

你还别说，微信官方真还圆了各位网友的愿望：

![](https://user-gold-cdn.xitu.io/2020/1/12/16f98c443e2178b1?w=1080&h=1080&f=png&s=1380975)

且不说有没有人信，这波网友的演技绝对是满分。

>注：本节图片来自新浪新闻->重庆商报在`2017年12月23日 12:35`的 文章，如有侵权请联系删除。

### 简要分析

本着“自己动手，丰衣足食”的精神，打算自己撸一个戴圣诞帽的脚本，毕竟微信官方要照顾这么多人的需要，着实挺忙的。

那么，要把一顶圣诞帽自动戴到头像（这里只考虑头像包含人脸的情况）的正确位置，需要怎样做呢？

下面是我认为的步骤：

1. 获取头像定位人脸
2. 获取人脸关键点
3. 获取合适的圣诞帽位置
4. 调整圣诞帽大小
5. 合成头像

### 人脸检测

要定位人脸就不得不说到人脸检测技术了。

人脸检测和识别的研究一直很火热，成熟的落地应用也非常多。多数地方坐火车可以刷脸进站，甚至有些地方在付钱的时候某付宝还支持刷脸付款。

与此同时，很多研究人员开源了自己的代码库供学习者参考。

本文采用的就是号称世界上最简洁的人脸识别库——`face_recognition`库。

#### 熟悉face_recognition

`face_recognition`的人脸识别基于业内领先的深度学习模型，在`Labeled Faces in the Wild`人脸数据集下有高达`99.38%`的准确率，唯一美中不足的是对小孩和亚洲人脸的识别准确率尚待提升。在实际使用中，人脸检测的效果还受脸部的光照以及遮挡等的影响，但无妨我们做研究。

最近有一部很火的电视剧《庆余年》，我们就拿这部剧中的人物来做实验。

下面是《庆余年》的剧照或是宣传照，真的是俊男美女呀：

![](https://user-gold-cdn.xitu.io/2020/1/12/16f98dd51b62d34e?w=402&h=325&f=png&s=280172)

![](https://user-gold-cdn.xitu.io/2020/1/12/16f98dd1fdf75496?w=320&h=480&f=png&s=216715)

![](https://user-gold-cdn.xitu.io/2020/1/12/16f98dd7480a4196?w=338&h=268&f=png&s=165955)

在这里提一下安装方法。由于`face_recognition`库依赖的`dlib`包需要编译，懒得麻烦的同学可以直接下载已经编译好了的`.whl`文件用`pip`命令安装，或者在公众号后台回复`face_recognition`获取。安装命令如下：

```shell
pip install dlib-****.whl
```

#### 人脸位置检测

既然是号称世界上最简洁的人脸识别库，代码必然很简洁。

首先自然是引入相关的包：

```python
import face_recognition
import cv2
```

然后用`face_recognition`来读取有人脸的图片：

```python
image = face_recognition.load_image_file('your-path-to-face')
```

关键代码来了：

```python
face_locations = face_recognition.face_locations(image)
```

对，你没看错，这一句话就检测到了图片中所有的人脸。简单的处理一下，在检测到脸的地方画一个框：

```python
for top, right, bottom, left in face_locations:
    cv2.rectangle(image, (left, top), (right, bottom), (0, 0, 255), 2)
    face_locations = face_recognition.face_locations(image)
cv2.imshow('rects_face', image[:,:,::-1])
cv2.waitKey(0)
```

细心的读者可能会注意到`image[:,:,::-1]`。原因是读取图片时，普通的方法一般是按照`R`、`G`、`B`的顺序排列，而`OpenCV`中则是以`B`、`G`、`R`的顺序排列，所以需要在最后一个维度使用`::-1`的方式进行倒序处理。

下面是人脸识别的结果：

![](https://user-gold-cdn.xitu.io/2020/1/12/16f98effbf695aee?w=408&h=361&f=png&s=285159)

![](https://user-gold-cdn.xitu.io/2020/1/12/16f98f07a6fce980?w=323&h=513&f=png&s=215399)

![](https://user-gold-cdn.xitu.io/2020/1/12/16f98f0e38711ae1?w=341&h=302&f=png&s=167376)

是不是很简单，加上包引入以及显示的代码总共才9行。

#### 人脸关键点检测

仔细观察检测到的脸部，会发现框住的位置都比较宽泛，没办法比较紧密的贴合脸部，这样后面戴圣诞帽会很难做。不过好在`face_recognition`库还为我们提供了人脸关键点检测功能，可以告诉我们五官的详细坐标。

在获取坐标之前，还是需要先检测到人脸代码与上面类似：

```python
image = face_recognition.load_image_file(face)
face_locations = face_recognition.face_locations(image)
face_landmarks = face_recognition.face_landmarks(image, face_locations)
```

还是一句代码解决问题。`face_landmarks`里面存储的便是五官详细位置。以“范闲”为例，`face_landmarks`的具体信息如下：

```python
[{
	'chin': [(148, 100), (149, 117), (152, 133), (155, 148), (161, 163), (169, 177), (178, 189), (190, 198), (203, 200), (216, 198), (226, 189), (235, 178), (244, 165), (250, 151), (254, 136), (257, 120), (259, 104)],
	'left_eyebrow': [(162, 105), (172, 103), (182, 106), (191, 109), (202, 112)],
	'right_eyebrow': [(213, 114), (222, 110), (231, 106), (241, 103), (250, 106)],
	'nose_bridge': [(206, 121), (206, 131), (206, 141), (206, 151)],
	'nose_tip': [(195, 156), (200, 157), (206, 159), (211, 157), (216, 155)],
	'left_eye': [(173, 118), (179, 117), (187, 117), (192, 121), (185, 123), (178, 122)],
	'right_eye': [(220, 122), (226, 118), (233, 117), (239, 119), (234, 123), (227, 123)],
	'top_lip': [(187, 174), (194, 171), (201, 169), (206, 171), (211, 169), (216, 171), (223, 173), (220, 174), (211, 174), (205, 175), (200, 174), (191, 174)],
	'bottom_lip': [(223, 173), (216, 180), (210, 184), (205, 185), (200, 184), (193, 181), (187, 174), (191, 174), (200, 175), (205, 176), (211, 175), (220, 174)]
}]
```

总共`72`个关键点，其中左右眉毛各`5`个、左右眼睛各`6`个、鼻子`5`个、鼻梁`4`个、上下嘴唇各`12`个和脸颊`17`个。

跟前面一样，为了直观的观察，用代码将这些点画出来，代码如下：

```python
for each in face_landmarks:
    for i in each.keys():
        for any in each[i]:
            points_face = cv2.circle(points_face, any, 3, (0,0,255), -1)
```

结果如下：

![](https://user-gold-cdn.xitu.io/2020/1/12/16f990694a81d80d?w=406&h=359&f=png&s=284200)

![](https://user-gold-cdn.xitu.io/2020/1/12/16f99071ebf2daa5?w=323&h=512&f=png&s=215568)

![](https://user-gold-cdn.xitu.io/2020/1/12/16f99078176775d7?w=342&h=302&f=png&s=168100)

有了这些关键点，我们就比较容易的定位圣诞帽的位置了。

### 下期预告

上面提到的这些都是`face_recognition`库提供的最基础的功能，`face_recognition`库还有更多更好玩的地方。下期我们会再简单介绍其他功能，然后实现我们的自动戴帽脚本，敬请期待~

### 后记

不管写什么，希望能跟更多人沟通，有问题或者需求随时欢迎交流。

我所有的项目源码都会放在下面的github仓库里面，有需要可以参考，有问题欢迎指正，谢谢！

```html
https://github.com/TitusWongCN/WeChatSubscriptionArticles
```

下面是我的公众号，有兴趣可以扫一下：

![](https://user-gold-cdn.xitu.io/2020/1/12/16f990f9b51e34b7?w=304&h=112&f=png&s=41105)

![](https://user-gold-cdn.xitu.io/2020/1/12/16f990fc76e85e97?w=258&h=258&f=png&s=20814)